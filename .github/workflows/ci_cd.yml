name: CI
on:
  push:
    branches:
      - 'release/*'
    tags:
      - "v*.*.*"
  pull_request:
    types: [opened, synchronize, reopened, labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  labeler:
    name: "Labels"
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
     - name: "Checkotu project"
       uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # 4.2.2

     - name: "Update labels"
       uses: micnncim/action-label-syncer@3abd5ab72fda571e69fffd97bd4e0033dd5f495c # v1.3.0
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

     - name: "Label pull-request"
       uses: actions/labeler@8558fd74291d67161a8a78ce36a881fa63b766a9 # v5.0.0
       with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}

  check-pr-title:
    name: "Check pull-request title follows conventional commits"
    runs-on: ubuntu-latest
    steps:
      - uses: ansys/actions/check-pr-title@1f1f205361706d22f67c71c29b775222380cd95a # v9.0.6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  code-style:
    name: "Code style checks"
    runs-on: ubuntu-latest
    needs: check-pr-title
    steps:
      - uses: ansys/actions/code-style@1f1f205361706d22f67c71c29b775222380cd95a # v9.0.6
        with:
          python-version: ${{ env.MAIN_PYTHON_VERSION }}

  docker-style:
    name: "Docker style ${{ matrix.directory }}"
    runs-on: ubuntu-latest
    needs: check-pr-title
    strategy:
      fail-fast: false
      matrix:
        directory: ['pic.Web', 'pic.ApiService']
    steps:
      - uses: ansys/actions/docker-style@v9.0
        with:
          directory: ${{ matrix.directory }}
          recursive: true
          error-level: 1
